@using Menhera.Classes
@model Post
@inject Menhera.Intefaces.IBoardCollection BoardCollection
@inject Menhera.Intefaces.IAdminCollection AdminCollection


@{
    Layout = "_Layout";
}
<head>
    <link rel="stylesheet" href="css/site.css">
    <title>@ViewBag.Board.Title</title>
</head>
<body>
<header>
    <div class="to-main">
        <a asp-action="Main" asp-controller="MainPage">
            На башорг!
        </a>
    </div>
    <div class="board">
        /@ViewBag.Board.Prefix/<span class="postfix">@BoardCollection.PrePostFixes.First(pair => pair.Key == ViewBag.Board.Prefix).Value</span>
    </div>
    <div class="title">
        @ViewBag.Board.Title
        <div class="description">
            @ViewBag.Board.Description
        </div>
    </div>
</header>
<section>
    <div class="form" style="margin-bottom: 17px">
        <!-- TODO: Добавить проверку забанен ли юзер -->
        <form enctype="multipart/form-data" method="post">
            <input type="hidden" name="parent" value=""> <!--TODO: В value отправлять id треда -->
            @{
                if (ViewBag.Board.AnonHasNoName)
                {
                    <input asp-for="Email" type="email" name="email" placeholder="Email" autocomplete="off" class="field full-email">
                }
                else
                {
                    <input asp-for="Email" type="email" name="email" placeholder="Email" autocomplete="off" class="field email">
                    <input asp-for="AnonName" type="text" name="name" placeholder="Имя" autocomplete="off" class="field email">
                }
                <input asp-action="AddThread" type="submit" value="Пост" class="field submit">
                <input asp-for="BoardId" type="hidden" value="@ViewBag.Board.BoardId">
                <input asp-for="AnonIpHash" type="hidden" value="@ViewBag.UserIp">
            }
            
            @{
                if (ViewBag.Board.HasSubject)
                {
                    <input asp-for="Subject" type="text" name="subject" placeholder="Тема" autocomplete="off" class="field">
                }
                <textarea asp-for="Comment" name="comment" placeholder="( . .)φ__" class="field comment"></textarea>
                if (ViewBag.Board.FilesAreAllowed)
                {
                    <input asp-for="File" type="file" name="files[]" multiple class="field">
                }
                <input type="checkbox" name="op" value="1" id="op">
                <label for="op">
                    оп
                </label>
            }
        </form>
    </div>
    <div class="functional-menu">
        <a asp-controller="MainPage" asp-action="Main">Главная</a>
        <a asp-controller="Board" asp-action="Search" asp-route-prefix="@ViewBag.Board.Prefix">Поиск</a>
        @if (User.Identity.IsAuthenticated)
        {
            <a asp-controller="Admin" asp-action="Panel">Управление</a>
        }
    </div>
    <div class="threads">
        @foreach (ThreadPostLastThreePosts item in ViewBag.ThreadPostPostsList)
        {
            <span id="@item.Thread.ThreadId">
                <article>
                    <div class="thread-header">
                        @{
                            if (!string.IsNullOrEmpty(item.Post.Subject))
                            {
                                <div class="subject">
                                    @item.Post.Subject
                                </div>
                            }
                            if (item.Post.AnonIpHash == ViewBag.UserIp)
                            {
                                <span class="your-thread">
                                </span>
                            }
                            if (!string.IsNullOrEmpty(item.Post.Email) && !string.IsNullOrEmpty(item.Post.AnonName))
                            {
                                <span class="name">
                                    <a href="mailto:@item.Post.Email">
                                        @item.Post.AnonName
                                    </a>
                                </span>
                            }
                            else if (!string.IsNullOrEmpty(item.Post.AnonName))
                            {
                                <span class="name">
                                    @item.Post.AnonName
                                </span>
                            }
                            if (item.Post.AnonIpHash == item.Thread.OpIpHash)
                            {
                                <span style="color: green; ">
                                    #OP
                                </span>
                            }
                            if (IpCheck.IpBelongsToAdmin(item.Post.AnonIpHash, AdminCollection.Admins, out Admin admin))
                            {
                                @admin.Login
                            }
                            @item.Post.Time
            <a asp-controller="Thread" asp-action="Thread" asp-route-id="@item.Post.ThreadId">@item.Post.ThreadId</a>
            <a asp-controller="Board" asp-action="Report" asp-route-postId="@item.Post.PostId">Репорт</a>
                            if (User.Identity.IsAuthenticated)
                            {
                                <a asp-controller="Admin" asp-action="Panel">
                                    Модерировать
                                </a>
                            }
            <a asp-controller="Thread" asp-action="Thread" asp-route-id="@item.Post.PostId">Ответ</a>
                            if (item.Post.IsPinned)
                            {
                                <img src="images/sticked.png" alt="sticked.png">
                            }
                            if (item.Thread.IsClosed)
                            {
                                <img src="images/closed.png" alt="closed.png">
                            }
                            <div class="comment">
                                @item.Post.Comment
                            </div>
                            <!-- TODO: Последние 3 поста в треде-->
                        }
                    </div>
                </article>
                <div class="posts">
                    @foreach (var post in item.LastThreePosts)
                    {
                        <span id="@post.PostId">
                            @{
                                var className = "post";
                                if (post.AnonIpHash == ViewBag.UserIp)
                                {
                                    className = "your-post";
                                }
                            }
                            <article class="@className">
                                <div class="thread-header">
                                    @if (!string.IsNullOrEmpty(post.Subject))
                                    {
                                        <div class="subject">
                                            @post.Subject
                                        </div>
                                    }
                                    @{
                                        if (!string.IsNullOrEmpty(item.Post.Email) && !string.IsNullOrEmpty(item.Post.AnonName))
                                        {
                                            <span class="name">
                                                <a href="mailto:@item.Post.Email">
                                                    @item.Post.AnonName
                                                </a>
                                            </span>
                                        }
                                        else if (!string.IsNullOrEmpty(item.Post.AnonName))
                                        {
                                            <span class="name">
                                                @item.Post.AnonName
                                            </span>
                                        }
                                        if (item.Post.AnonIpHash == item.Thread.OpIpHash)
                                        {
                                            <span style="color: green; ">
                                                #OP
                                            </span>
                                        }
                                        if (IpCheck.IpBelongsToAdmin(item.Post.AnonIpHash, AdminCollection.Admins, out var admin_))
                                        {
                                            @admin_.Login
                                        }
                                        @item.Post.Time
                        <a asp-controller="Thread" asp-action="Thread" asp-route-id="@item.Post.ThreadId">@item.Post.ThreadId</a>
                        <a asp-controller="Board" asp-action="Report" asp-route-postId="@item.Post.PostId">Репорт</a>
                                        if (User.Identity.IsAuthenticated)
                                        {
                                            <a asp-controller="Admin" asp-action="Panel">
                                                Модерировать
                                            </a>
                                        }
                        <a asp-controller="Thread" asp-action="Thread" asp-route-id="@item.Post.PostId">Ответ</a>
                                        if (item.Post.IsPinned)
                                        {
                                            <img src="images/sticked.png" alt="sticked.png">
                                        }
                                        if (item.Thread.IsClosed)
                                        {
                                            <img src="images/closed.png" alt="closed.png">
                                        }
                                        <div class="comment">
                                            @item.Post.Comment
                                        </div>
                                    }
                                </div>
                            </article>
                        </span>
                    }
                </div>
            </span>
        }
    </div>
</section>
</body>
